{% extends "base.html" %}

{% block content %}
<div class="background-container"></div>
<div class="main-container">
    <div class="form-section">
        <h2 class="mb-4 usuarios-admin-titulo">Cadastro de Cliente</h2>
        
        <form id="cadastroForm">
            <div class="form-grid">
                <div class="form-group">
                    <label for="data">Data (DD/MM/AAAA)</label>
                    <input type="text" id="data" name="data" placeholder="DD/MM/AAAA" required>
                </div>
                
                <div class="form-group">
                    <label for="cliente">CLIENTE</label>
                    <select class="form-select" id="cliente" name="cliente_id" required>
                    <option value="">Selecione um cliente...</option>
                    {% for cliente in clientes %}
                        <option value="{{ cliente['id'] }}">{{ cliente['nome'] }}</option>
                    {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="mod_carsten">MOD CARSTEN</label>
                    <select class="form-select" id="mod_carsten" name="mod_carsten" multiple required>
                        <option value="">Selecione colaboradores...</option>
                        {% for colaborador in colaboradores %}
                            <option value="{{ colaborador['nome'] }}">{{ colaborador['nome'] }}</option>
                        {% endfor %}
                    </select>
                    <small class="form-text text-muted">Pressione Ctrl (ou Cmd no Mac) para selecionar múltiplos colaboradores</small>
                </div>
                
                <div class="form-group">
                    <label for="mdo_terceiro">MDO 3º</label>
                    <input type="number" step="0.01" id="mdo_terceiro" name="mdo_terceiro" required>
                </div>
                
                <div class="form-group">
                    <label for="total_volumes">TOTAL VOLUMES</label>
                    <input type="number" step="0.01" id="total_volumes" name="total_volumes" required>
                </div>
                

            </div>
            
            <div class="button-group">
                <button type="submit" class="btn btn-success">
                    <i class="bi bi-save"></i> Salvar
                </button>
                
                <a href="{{ url_for('historico_cadastros') }}" class="btn btn-primary">
                    <i class="bi bi-list-check"></i> Histórico de Cadastros
                </a>
                <a href="{{ url_for('historico_escalas') }}" class="btn btn-info">
                    <i class="bi bi-people-fill"></i> Colaboradores Carsten
                </a>
            </div>
        </form>
        
        <div id="resultado" class="mt-3"></div>
        <div id="volPessoa" class="mt-2 fw-bold"></div>
    </div>
    

</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // Formatação da data
    $('#data').on('keyup', function() {
        let value = $(this).val().replace(/\D/g, '');
        if (value.length > 2) {
            value = value.substring(0, 2) + '/' + value.substring(2);
        }
        if (value.length > 5) {
            value = value.substring(0, 5) + '/' + value.substring(5, 9);
        }
        $(this).val(value);
    });



    // Cálculo automático de VOL/PESSOA
    $('select[name="mod_carsten"], input[name="mdo_terceiro"], input[name="total_volumes"]').on('change', function() {
        // Para MOD CARSTEN, contar quantos colaboradores foram selecionados
        const modSelected = $('#mod_carsten').val();
        const mod = Array.isArray(modSelected) ? modSelected.length : (modSelected ? 1 : 0);
        const mdo = parseFloat($('#mdo_terceiro').val()) || 0;
        const volumes = parseFloat($('#total_volumes').val()) || 0;
        
        if (mod + mdo > 0) {
            const volPessoa = (volumes / (mod + mdo)).toFixed(2);
            $('#volPessoa').text(`VOL/PESSOA: ${volPessoa}`);
        } else {
            $('#volPessoa').text('');
        }
    });

    // Envio do formulário
    $('#cadastroForm').submit(function(e) {
        e.preventDefault();
        
        $.ajax({
            url: "{{ url_for('salvar') }}",
            type: "POST",
            data: $(this).serialize(),
            success: function(response) {
                if (response.success) {
                    $('#resultado').html(`
                        <div class="alert alert-success">
                            ${response.message}
                        </div>
                    `);
                    $('#cadastroForm')[0].reset();
                    $('#volPessoa').text(`VOL/PESSOA: ${response.vol_pessoa}`);
                } else {
                    $('#resultado').html(`
                        <div class="alert alert-danger">
                            ${response.message}
                        </div>
                    `);
                }
            }
        });
    });
});
</script>
{% endblock %}